<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–†–µ–¥–∞–∫—Ç–æ—Ä –Ω–æ—Ç Fightify</title>
<style>
  body {
    margin: 0; background: #2a2230; color: #eee; font-family: 'Orbitron', monospace, monospace;
    user-select: none;
  }
  #controls {
    background: #3e3340; padding: 10px; display: flex; align-items: center; gap: 10px;
    border-bottom: 2px solid #a61241;
  }
  button, select, input[type="file"] {
    font-family: 'Orbitron', monospace; font-weight: 700; background: #5e4d53; color: #eee;
    border: 2px solid #a61241; border-radius: 4px; padding: 6px 12px;
    cursor: pointer;
  }
  button:hover, select:hover, input[type="file"]:hover {
    background: #a61241; color: #fff;
  }
  #editorArea {
    position: relative; height: 400px; background: #1f1925; overflow: hidden;
    margin: 20px; border: 2px solid #a61241; border-radius: 8px;
  }
  .note {
    position: absolute; width: 40px; height: 40px; border-radius: 8px;
    background: #a61241; color: white; font-weight: 900; font-size: 24px;
    text-align: center; line-height: 40px; user-select: none;
    transition: opacity 0.5s ease-out;
    pointer-events: auto;
    cursor: pointer;
  }
  .note.highlight {
    background: #ff416c;
    box-shadow: 0 0 12px #ff416c;
  }
  .note.fading {
    opacity: 0;
  }
</style>
</head>
<body>

<div id="controls">
  <button id="playPauseBtn">Play</button>
  <button id="modeBtn">–†–µ–∂–∏–º: –†–µ–¥–∞–∫—Ç–æ—Ä</button>
  <label for="fileInput" style="cursor:pointer;">–í—ã–±—Ä–∞—Ç—å –∞—É–¥–∏–æ</label>
  <input type="file" id="fileInput" accept="audio/*" style="display:none;">
  <select id="keySelector" title="–í—ã–±–µ—Ä–∏ –∫–ª–∞–≤–∏—à—É –¥–ª—è –Ω–æ—Ç—ã">
    <option value="A">A</option>
    <option value="S">S</option>
    <option value="D">D</option>
    <option value="F">F</option>
    <option value="M">–ü–ö–ú</option>
  </select>
  <input type="range" id="seekSlider" min="0" max="100" value="0" style="flex-grow:1; margin-left:10px;"/>
</div>

<div id="editorArea" title="–ö–ª–∏–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ—Ç—É"></div>

<audio id="audioTrack"></audio>

<script>
  const editorArea = document.getElementById('editorArea');
  const audioTrack = document.getElementById('audioTrack');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const modeBtn = document.getElementById('modeBtn');
  const fileInput = document.getElementById('fileInput');
  const keySelector = document.getElementById('keySelector');
  const seekSlider = document.getElementById('seekSlider');
  let mode = 'edit'; // 'edit' –∏–ª–∏ 'test'
  let notes = [];
  let noteIdCounter = 0;
  let currentKey = 'A';
  const noteWidth = 40, noteHeight = 40;

  // –û–±–Ω–æ–≤–ª—è–µ–º max –∏ value —Å –¥–ª–∏–Ω–æ–π –∏ —Ç–µ–∫—É—â–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –∞—É–¥–∏–æ
  audioTrack.addEventListener('loadedmetadata', () => {
    seekSlider.max = audioTrack.duration;
  });

  audioTrack.addEventListener('timeupdate', () => {
    if (!seekSlider.dragging) { // –ß—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º
      seekSlider.value = audioTrack.currentTime;
    }
  });

// –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–µ—Ä–µ–º–æ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
  seekSlider.dragging = false;

  seekSlider.addEventListener('mousedown', () => {
    seekSlider.dragging = true;
  });
  seekSlider.addEventListener('mouseup', () => {
    seekSlider.dragging = false;
    audioTrack.currentTime = seekSlider.value;
  });
  seekSlider.addEventListener('input', () => {
    // –ß—Ç–æ–±—ã —Å–ª–∞–π–¥–µ—Ä –ø–ª–∞–≤–Ω–æ –ø–µ—Ä–µ–º–∞—Ç—ã–≤–∞–ª—Å—è –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –º—ã—à–∏
      if (seekSlider.dragging) {
      audioTrack.currentTime = seekSlider.value;
      renderNotes();
    }
  });


  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞
  modeBtn.onclick = () => {
    if (!audioTrack.src) {
      alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ!');
      return;
    }
    if (mode === 'edit') {
      mode = 'test';
      modeBtn.textContent = '–†–µ–∂–∏–º: –¢–µ—Å—Ç';
      renderNotes();
    } else {
      mode = 'edit';
      modeBtn.textContent = '–†–µ–∂–∏–º: –†–µ–¥–∞–∫—Ç–æ—Ä';
      renderNotes();
    }
  };

  // –ö–Ω–æ–ø–∫–∞ Play/Pause
  playPauseBtn.onclick = () => {
    if (!audioTrack.src) {
      alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ!');
      return;
    }
    if (audioTrack.paused) {
      audioTrack.play();
      playPauseBtn.textContent = 'Pause';
    } else {
      audioTrack.pause();
      playPauseBtn.textContent = 'Play';
    }
  };

  // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞—É–¥–∏–æ
  fileInput.onchange = (e) => {
    if (e.target.files.length === 0) return;
    const file = e.target.files[0];
    const url = URL.createObjectURL(file);
    audioTrack.src = url;
    audioTrack.load();
    notes = [];
    noteIdCounter = 0;
    mode = 'edit';
    modeBtn.textContent = '–†–µ–∂–∏–º: –†–µ–¥–∞–∫—Ç–æ—Ä';
    playPauseBtn.textContent = 'Play';
    renderNotes();
  };

  // –í—ã–±–æ—Ä –∫–ª–∞–≤–∏—à–∏
  keySelector.onchange = (e) => {
    currentKey = e.target.value;
  };

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ—Ç—ã –ø–æ –∫–ª–∏–∫—É (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞)
  editorArea.addEventListener('click', (e) => {
    if (mode !== 'edit') return;
    const rect = editorArea.getBoundingClientRect();
    const x = e.clientX - rect.left - noteWidth / 2;
    const y = e.clientY - rect.top - noteHeight / 2;

    const time = audioTrack.currentTime;
    notes.push({
      id: noteIdCounter++,
      x: Math.min(Math.max(0, x), editorArea.clientWidth - noteWidth),
      y: Math.min(Math.max(0, y), editorArea.clientHeight - noteHeight),
      key: currentKey,
      time: time,
      fading: false,
      highlight: false,
    });
    renderNotes();
  });
  



  // –†–µ–Ω–¥–µ—Ä –Ω–æ—Ç
  function renderNotes() {
    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –Ω–æ—Ç
    editorArea.querySelectorAll('.note').forEach(n => n.remove());
    const currentTime = audioTrack.currentTime;

    notes.forEach(note => {
      if (note.fading) return;

      // –í —Ä–µ–∂–∏–º–µ —Ç–µ—Å—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ—Ç—ã, –µ—Å–ª–∏ –∏—Ö –≤—Ä–µ–º—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 0.5 —Å–µ–∫ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
      if (mode === 'test') {
        if (Math.abs(note.time - currentTime) > 0.5) return;
      }

      const div = document.createElement('div');
      div.classList.add('note');
      div.textContent = note.key === 'M' ? 'üñ±' : note.key;
      div.style.left = note.x + 'px';
      div.style.top = note.y + 'px';
      div.dataset.id = note.id;

      // –í —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ, –≤ —Ç–µ—Å—Ç–µ ‚Äî –Ω–µ—Ç
      if (mode === 'edit') {
        div.style.cursor = 'pointer';
        div.onclick = (e) => {
          e.stopPropagation();
          if (mode === 'edit') {
            // –í —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –∫–ª–∏–∫ —É–¥–∞–ª—è–µ—Ç –Ω–æ—Ç—É
            notes = notes.filter(n => n.id !== note.id);
          } else if (mode === 'test') {
            // –í —Ç–µ—Å—Ç–µ –∫–ª–∏–∫ –ø–æ –Ω–æ—Ç–µ ‚Äî –ø–æ–ø—ã—Ç–∫–∞ "–ø–æ–ø–∞—Å—Ç—å" –ø–æ –Ω–æ—Ç–µ (fade)
            fadeOutNote(note.id);
          }
          renderNotes();
        };

      }

      editorArea.appendChild(div);
    });
  }

  // –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ, —á—Ç–æ–±—ã –Ω–æ—Ç—ã –ø–æ—è–≤–ª—è–ª–∏—Å—å/–∏—Å—á–µ–∑–∞–ª–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
  function tick() {
    if (mode === 'test') {
      renderNotes();
    }
    requestAnimationFrame(tick);
  }
  tick();

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –∫–ª–∞–≤–∏—à –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
  window.addEventListener('keydown', (e) => {
    if (mode !== 'test') return;

    let pressedKey = e.key.toUpperCase();

    // –î–ª—è –ü–ö–ú - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±—É–¥–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ
    if (!['A', 'S', 'D', 'F'].includes(pressedKey)) return;

    let currentTime = audioTrack.currentTime;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ—Ç—ã –≤ ¬±0.5 —Å–µ–∫ —Å —Ç–µ–∫—É—â–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º –∫–ª–∞–≤–∏—à–∏
    for (let i = 0; i < notes.length; i++) {
      const note = notes[i];
      if (note.fading) continue;
      if (note.key !== pressedKey) continue;
      if (Math.abs(note.time - currentTime) <= 0.5) {
        fadeOutNote(note.id);
        break;
      }
    }
  });


  function fadeOutNote(id) {
    const el = document.querySelector(`.note[data-id="${id}"]`);
    if (!el) return;
    el.style.opacity = '0.2';
    el.style.transform = 'scale(0.8)';
    el.style.transition = 'all 0.2s ease';
    setTimeout(() => {
      if (el.parentNode) el.remove();
    }, 200);
  }


  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ü–ö–ú (–ø—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏) –¥–ª—è –Ω–æ—Ç —Å key='M' –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
  editorArea.addEventListener('contextmenu', (e) => {
    if (mode !== 'test') return;
    e.preventDefault();
    const currentTime = audioTrack.currentTime;
    for (let i = 0; i < notes.length; i++) {
      const note = notes[i];
      if (note.fading) continue;
      if (note.key !== 'M') continue;
      if (Math.abs(note.time - currentTime) <= 0.5) {
        fadeOutNote(note.id);
        break;
      }
    }
  });

  // –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –Ω–æ—Ç—ã –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –º–∞—Å—Å–∏–≤–∞
  function fadeOutNote(id) {
    const note = notes.find(n => n.id === id);
    if (!note) return;
    note.fading = true;
    renderNotes();

    setTimeout(() => {
      notes = notes.filter(n => n.id !== id);
      renderNotes();
    }, 500);
  }

</script>

</body>
</html>
