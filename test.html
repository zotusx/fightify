<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fightify Map Editor - Test & Play</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron&display=swap');
  body, html {
    margin: 0; padding: 0; height: 100vh; background: #5e4d53; font-family: 'Orbitron', monospace;
    user-select: none;
    overflow: hidden;
  }
  #app {
    display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    height: 100vh; padding: 10px;
    background: #5e4d53;
    box-sizing: border-box;
  }
  #editorArea {
    position: relative;
    width: 1024px; height: 400px;
    border: 2px solid #a61241;
    background: #3e3340;
    margin-bottom: 8px;
    overflow: hidden;
    cursor: crosshair;
  }
  .note {
    position: absolute;
    width: 40px; height: 40px; /* 2.5x bigger from 16 */
    border-radius: 8px;
    background: #a61241;
    color: white;
    font-weight: bold;
    font-size: 18px;
    text-align: center;
    line-height: 40px;
    user-select: none;
    transition: background-color 0.3s ease;
    pointer-events: auto;
  }
  .note.highlight {
    background: #d94949;
    box-shadow: 0 0 12px #d94949aa;
  }
  .note.fading {
    transition: opacity 1.2s ease;
    opacity: 0 !important;
  }
  #controls {
    width: 1024px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: white;
  }
  #audioControls {
    flex: 1;
  }
  #audioSlider {
    width: 500px;
  }
  button {
    background: #a61241;
    color: white;
    border: none;
    padding: 8px 14px;
    cursor: pointer;
    font-weight: 700;
    font-family: 'Orbitron', monospace;
    user-select: none;
    border-radius: 5px;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: #d94949;
  }
  #modeToggle {
    margin-left: 10px;
  }
  #info {
    margin-top: 6px;
    color: #ccc;
    font-size: 14px;
    font-family: monospace;
    width: 1024px;
  }
</style>
</head>
<body>
<div id="app">
  <div id="editorArea" title="–ö–ª–∏–∫ –ø–æ –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ—Ç—ã (–≤ —Ä–µ–∂–∏–º–µ –†–µ–¥–∞–∫—Ç–æ—Ä–∞)."></div>
  <div id="controls">
    <div id="audioControls">
      <button id="playPauseBtn">Play ‚ñ∂Ô∏è</button>
      <input type="range" id="audioSlider" min="0" max="100" value="0" step="0.1" />
      <span id="timeDisplay">00:00 / 00:00</span>
    </div>
    <button id="modeToggle">–ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –¢–µ—Å—Ç</button>
  </div>
  <div id="info">
    <b>–†–µ–¥–∞–∫—Ç–æ—Ä:</b> –î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ—Ç—ã –∫–ª–∏–∫–∞–º–∏ –ø–æ –æ–±–ª–∞—Å—Ç–∏. –ù–æ—Ç—ã –æ–±–æ–∑–Ω–∞—á–µ–Ω—ã –∫–ª–∞–≤–∏—à–∞–º–∏: A S D F –∏ –ü–ö–ú.<br>
    <b>–¢–µ—Å—Ç:</b> –ù–∞–∂–º–∏—Ç–µ –∫–ª–∞–≤–∏—à—É, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –Ω–æ—Ç–µ (A,S,D,F, –ü–ö–ú) –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ ‚Äî –Ω–æ—Ç–∞ –∏—Å—á–µ–∑–∞–µ—Ç —Å –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π.<br>
    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Å–≤–µ—Ä—Ö—É.
  </div>
</div>

<audio id="audioTrack" src="https://cdn.pixabay.com/download/audio/2022/03/30/audio_1d5644ea8b.mp3?filename=happy-ukulele-128.mp3"></audio>

<script>
(() => {
  const editorArea = document.getElementById('editorArea');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const audioSlider = document.getElementById('audioSlider');
  const audioTrack = document.getElementById('audioTrack');
  const timeDisplay = document.getElementById('timeDisplay');
  const modeToggle = document.getElementById('modeToggle');

  let notes = [];
  let noteIdCounter = 0;
  let mode = 'edit'; // 'edit' or 'test'

  // –†–∞–∑–º–µ—Ä –∏ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–æ—Ç
  const noteWidth = 40;
  const noteHeight = 40;

  // –ö–ª–∞–≤–∏—à–∏ –¥–ª—è –Ω–æ—Ç (–∏ –ü–ö–ú –æ—Ç–¥–µ–ª—å–Ω–æ)
  const keyMap = ['A','S','D','F'];
  // –ü–ö–ú note key represented as "M" internally
  const mouseKeyName = 'M';

  function formatTime(seconds) {
    const m = Math.floor(seconds/60).toString().padStart(2,'0');
    const s = Math.floor(seconds%60).toString().padStart(2,'0');
    return `${m}:${s}`;
  }

  function renderNotes() {
    editorArea.querySelectorAll('.note').forEach(n => n.remove());
    notes.forEach(n => {
      if (n.fading) return; // skip fading fully removed notes
      const div = document.createElement('div');
      div.classList.add('note');
      if(n.highlight) div.classList.add('highlight');
      if(n.fading) div.classList.add('fading');
      div.textContent = n.key === mouseKeyName ? 'üñ±' : n.key;
      div.style.left = n.x + 'px';
      div.style.top = n.y + 'px';
      div.dataset.id = n.id;
      editorArea.appendChild(div);
    });
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ—Ç—É –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
  function addNote(x, y) {
    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ —Å–µ—Ç–∫–µ –ø–æ —à–∏—Ä–∏–Ω–µ –Ω–æ—Ç
    x = Math.min(Math.max(0, x - noteWidth/2), editorArea.clientWidth - noteWidth);
    y = Math.min(Math.max(0, y - noteHeight/2), editorArea.clientHeight - noteHeight);
    // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∫–ª–∞–≤–∏—à—É —Ü–∏–∫–ª–∏—á–Ω–æ –ø–æ –ø–æ—Ä—è–¥–∫—É
    const keyIndex = notes.length % 5;
    const key = keyIndex < 4 ? keyMap[keyIndex] : mouseKeyName;
    notes.push({id: noteIdCounter++, x, y, key, fading:false, highlight:false});
    renderNotes();
  }

  // –ü–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ –Ω–æ—Ç—ã
  function fadeOutNote(id) {
    const note = notes.find(n=>n.id===id);
    if(!note || note.fading) return;
    note.fading = true;
    renderNotes();
    // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 1.2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –ø–ª–∞–≤–Ω–æ–≥–æ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
    setTimeout(() => {
      notes = notes.filter(n => n.id !== id);
      renderNotes();
    }, 1200);
  }

  // –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –≤—ã–¥–µ–ª—è–µ–º –Ω–æ—Ç—É –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –µ—Å–ª–∏ –∫–ª–∞–≤–∏—à–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
  function updateHighlights(mouseX, mouseY, pressedKeys) {
    if(mode !== 'test') return;
    let anyHighlight = false;
    notes.forEach(n => {
      if(n.fading) {
        n.highlight = false;
        return;
      }
      if (mouseX >= n.x && mouseX <= n.x + noteWidth &&
          mouseY >= n.y && mouseY <= n.y + noteHeight) {
        // –ù–∞–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –Ω–æ—Ç—É
        // –í—ã–¥–µ–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∞–≤–∏—à–∞ –Ω–∞–∂–∞—Ç–∞ –∏–ª–∏ –∫—É—Ä—Å–æ—Ä —Ç–∞–º (–¥–ª—è –≤–∏–∑—É–∞–ª–∞)
        if (pressedKeys.has(n.key)) {
          n.highlight = true;
          anyHighlight = true;
        } else {
          n.highlight = true;
          anyHighlight = true;
        }
      } else {
        n.highlight = false;
      }
    });
    renderNotes();
    return anyHighlight;
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–ª–∞–π–¥–µ—Ä–∞ –∏ –≤—Ä–µ–º–µ–Ω–∏
  function updateAudioProgress() {
    if (audioTrack.duration) {
      const current = audioTrack.currentTime;
      const dur = audioTrack.duration;
      audioSlider.value = (current/dur)*100;
      timeDisplay.textContent = `${formatTime(current)} / ${formatTime(dur)}`;
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  function init() {
    renderNotes();

    editorArea.addEventListener('click', (e) => {
      if(mode !== 'edit') return;
      const rect = editorArea.getBoundingClientRect();
      addNote(e.clientX - rect.left, e.clientY - rect.top);
    });

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—É–¥–∏–æ
    playPauseBtn.addEventListener('click', () => {
      if(audioTrack.paused) {
        audioTrack.play();
        playPauseBtn.textContent = 'Pause ‚è∏';
      } else {
        audioTrack.pause();
        playPauseBtn.textContent = 'Play ‚ñ∂Ô∏è';
      }
    });

    audioSlider.addEventListener('input', () => {
      if(audioTrack.duration) {
        audioTrack.currentTime = (audioSlider.value / 100) * audioTrack.duration;
      }
    });

    audioTrack.addEventListener('timeupdate', updateAudioProgress);
    audioTrack.addEventListener('ended', () => {
      playPauseBtn.textContent = 'Play ‚ñ∂Ô∏è';
      audioSlider.value = 0;
    });

    // –†–µ–∂–∏–º—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä / —Ç–µ—Å—Ç
    modeToggle.addEventListener('click', () => {
      if(mode === 'edit') {
        mode = 'test';
        modeToggle.textContent = '–ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
        editorArea.style.cursor = 'default';
        // –û—Å—Ç–∞–Ω–æ–≤–∏–º —Ç—Ä–µ–∫ –∏ —Ä–µ—Å–µ—Ç –ø–æ–∑–∏—Ü–∏—é
        audioTrack.pause();
        audioTrack.currentTime = 0;
        playPauseBtn.textContent = 'Play ‚ñ∂Ô∏è';
      } else {
        mode = 'edit';
        modeToggle.textContent = '–ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –¢–µ—Å—Ç';
        editorArea.style.cursor = 'crosshair';
      }
      renderNotes();
    });

    // –¢–µ—Å—Ç–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –Ω–æ—Ç –ø–æ –Ω–∞–∂–∞—Ç–∏—é –∫–ª–∞–≤–∏—à –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
    const pressedKeys = new Set();

    // –î–ª—è –º—ã—à–∫–∏: –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–∫ –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–æ–π (contextmenu)
    editorArea.addEventListener('contextmenu', e => {
      if(mode !== 'test') return;
      e.preventDefault();
      const rect = editorArea.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      // –ò—â–µ–º –Ω–æ—Ç—É –ø–æ–¥ –º—ã—à—å—é —Å key "M"
      for(let n of notes) {
        if(n.fading) continue;
        if(n.key === mouseKeyName &&
           x >= n.x && x <= n.x + noteWidth &&
           y >= n.y && y <= n.y + noteHeight) {
          fadeOutNote(n.id);
          break;
        }
      }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –º—ã—à–∏ –≤ —Ä–µ–∂–∏–º–µ —Ç–µ—Å—Ç–∞
    editorArea.addEventListener('mousemove', e => {
      if(mode !== 'test') return;
      const rect = editorArea.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      updateHighlights(mouseX, mouseY, pressedKeys);
    });

    editorArea.addEventListener('mouseleave', () => {
      if(mode !== 'test') return;
      notes.forEach(n => n.highlight = false);
      renderNotes();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    window.addEventListener('keydown', e => {
      if(mode !== 'test') return;
      const key = e.key.toUpperCase();
      pressedKeys.add(key);
      // –ù–∞—Ö–æ–¥–∏–º –Ω–æ—Ç—É –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º —Å —ç—Ç–æ–π –∫–ª–∞–≤–∏—à–µ–π –∏ —É–¥–∞–ª—è–µ–º
      // –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –º—ã—à–∏, –Ω–æ –≤ window —Å–æ–±—ã—Ç–∏–∏ –º—ã –µ—ë –Ω–µ –∑–Ω–∞–µ–º, 
      // –ø–æ—Ç–æ–º—É —Å–¥–µ–ª–∞–µ–º —Ç–∞–∫: —É–¥–∞–ª—è—Ç—å –≤—Å–µ –Ω–æ—Ç—ã —Å —ç—Ç–∏–º –∫–ª—é—á–æ–º, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–¥–µ–ª–µ–Ω—ã (highlight)
      let anyDeleted = false;
      notes.filter(n => n.highlight && n.key === key && !n.fading).forEach(n => {
        fadeOutNote(n.id);
        anyDeleted = true;
      });
      if(anyDeleted) e.preventDefault();
    });

    window.addEventListener('keyup', e => {
      if(mode !== 'test') return;
      const key = e.key.toUpperCase();
      pressedKeys.delete(key);
      // –£–±–µ—Ä–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É, –µ—Å–ª–∏ –∫–ª–∞–≤–∏—à–∞ –æ—Ç–ø—É—â–µ–Ω–∞
      notes.forEach(n => {
        if(n.key === key) n.highlight = false;
      });
      renderNotes();
    });
  }

  init();
})();
</script>
</body>
</html>
